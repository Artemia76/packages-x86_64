# Depends on: libgcrypt zlib cmake cmocka doxygen

description="Library for accessing ssh client services through C libraries"
url="https://www.libssh.org/"
packager="tnut <tnut@nutyx.org>"
contributors="greg"

run=()

name=libssh
version=0.8.2

source=($url/files/0.8/$name-$version.tar.xz
libssh-fix-read-config.patch
)

prepare() {
sed 's/unit_test(torture_path_expand_tilde_unix),//' -i libssh-${version}/tests/unittests/torture_misc.c
mkdir -p build
cd $name-$version
# Fix reading SSH configuration files
# patch -p1 -i ../libssh-fix-read-config.patch
}

build() {
cd build
cmake ../$name-$version \
-DCMAKE_INSTALL_PREFIX=/usr \
-DCMAKE_BUILD_TYPE=Release \
-DWITH_GSSAPI=OFF \
-DWITH_GCRYPT=ON \
-DWITH_TESTING=ON
make
make DESTDIR=$PKG install
}

uptodate() {
local url ext
url="https://www.libssh.org/files/"
ext=".tar.xz"
latest="`lynx -read_timeout=20 -dump -listonly -nonumbers \
$url?C=M\;O=D|grep [0-9]/$|head -1`"

lynx -read_timeout=20 -dump -listonly -nonumbers \
$latest?C=M\;O=A|grep $name-[0-9]|grep [0-9]$ext$| \
sed "s@$latest$name-@@"|sed "s@$ext@@"|tail -1
}
