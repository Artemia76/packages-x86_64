description="Tools which simplify and make the network more directly manageable."
url="http://projects.gnome.org/NetworkManager/"

packager="tnut <tnut@nutyx.org>"
contributors="Pierre B, Greg"

makedepends=(libndp libsoup libgudev dbus-glib iptables libnl
             nss wireless-tools polkit upower vala 
             gobject-introspection newt
             python-gobject gtk-doc meson ninja)
run=(wpa-supplicant wpa-supplicant-dbus dhcpcd)

alias=(NetworkManager)

_name=NetworkManager

name=networkmanager
version=1.22.10

source=(https://download.gnome.org/sources/$_name/${version:0:4}/$_name-$version.tar.xz)

prepare() {
sed -i '/initrd/d' ${_name}-$version/src/meson.build
grep -rl '^#!.*python$'| xargs sed -i '1s/python/&3/'
mkdir build
}

build() {

cd build
CXXFLAGS+=" -fPIC"              \
meson --prefix        /usr      \
      --sysconfdir    /etc      \
      --localstatedir /var      \
      -Dudev_dir=/lib/udev      \
      -Dlibnm_glib=true         \
      -Dsession_tracking="no"   \
      -Dlibaudit=no             \
      -Dlibpsl=false            \
      -Dnmtui=true              \
      -Dselinux=false           \
      -Dsystemdsystemunitdir=no \
      -Dsystemd_journal=false   \
      -Djson_validation=false   \
      -Dqt=false                \
      -Dovs=false               \
      -Dppp=false               \
      -Dmodem_manager=false     \
      -Ddocs=true               \
      ../${_name}-$version
ninja
DESTDIR=$PKG ninja install

mv $PKG/usr/share/doc/NetworkManager{,-$version}
# create a VPN directory
install -d $PKG/etc/$_name/VPN

# create keyfile plugin system-settings directory
install -d $PKG/etc/${_name}/system-connections

# Minimum config to make NetworkManager working
cat >> $PKG/etc/${_name}/${_name}.conf << "EOF"
[main]
plugins=keyfile
EOF

# Allow polkit to manage authorizations
cat > $PKG/etc/${_name}/conf.d/polkit.conf << "EOF"
[main]
auth-polkit=true
EOF

# Avoid NetworkManager using his own dhcp client
cat > $PKG/etc/${_name}/conf.d/dhcp.conf << "EOF"
[main]
dhcp=dhcpcd
EOF

# Preventing NetworkManager updating /etc/resolv.conf
cat > $PKG/etc/${_name}/conf.d/no-dns-update.conf << "EOF"
[main]
dns=none
EOF

mkdir -p $PKG/usr/share/polkit-1/rules.d
cat > $PKG/usr/share/polkit-1/rules.d/org.freedesktop.NetworkManager.rules << "EOF"
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("org.freedesktop.NetworkManager.") == 0 && subject.isInGroup("netdev")) {
        return polkit.Result.YES;
    }
});
EOF

#
# Init Service stuff
SERVICEDIR=lib/runit/services/${_name}
mkdir -p $PKG/{var/log/${_name},$SERVICEDIR/{,log}}

cat > $PKG/$SERVICEDIR/run << "EOF"
#!/bin/sh
sv check dbus >/dev/null || exit 1
exec NetworkManager -n > /dev/null 2&>1
EOF
cat > $PKG/$SERVICEDIR/log/run << "EOF"
#!/bin/sh
exec chpst svlogd -tt /var/log/NetworManager
EOF


chmod 755 $PKG/$SERVICEDIR/{run,/log/run} 
}

uptodate(){
local latest lastversion url
url="https://download.gnome.org/sources/${_name}"
latest="`lynx -read_timeout=20 -dump -listonly -nonumbers \
$url/?C=N\;O=D|grep [0-9]/$|head -1`"
lastversion="`lynx -read_timeout=20 -dump -listonly -nonumbers \
$latest/?C=N\;O=D|grep LATEST|grep [0-9]$|cut -d "-" -f3`"
echo "$lastversion"
}
