# Depends on: git gperf qt5 xorg-libxcomposite xorg-libxrandr xorg-libxtst xorg-libxcursor pulseaudio pciutils libxss libvpx opus libevent libwebp snappy nss protobuf  

description="Provides support for web applications using the Chromium browser project"
url="http://qt-project.org/"
packager="pierre at nutyx dot org"
alias=(qt5webengine qtwebengine qt-webengine)

run=(xorg-xtrans xorg-libfs xorg-libxxf86dga gstreamer cdparanoia gstreamer-plugins-base ruby postgresql)

name=qt5-webengine
release=5

_version=${version/-/}
_name=qtwebengine-opensource-src-${_version}
_namefqn="${name/5-/}-opensource-src-${_version}"

source=(http://download.qt.io/official_releases/qt/${version%.*}/${_version}/submodules/${_namefqn}.tar.xz
        qt5-webengine-fno-delete-null-pointer-checks.patch 
        qt5-webengine-fno-delete-null-pointer-checks-2.patch)
       
build() {
  QT5DIR=/usr
  QT5PREFIX=/usr
  QT5BINDIR=/usr/lib/qt5/bin
  SAVEPATH=$PATH

  # Workaround for v8 segfaults with GCC 6
  cd ${_namefqn}
  patch -p1 -i $SRC/qt5-webengine-fno-delete-null-pointer-checks.patch
  cd src/3rdparty
  patch -p1 -i $SRC/qt5-webengine-fno-delete-null-pointer-checks-2.patch
  cd $SRC

  mkdir build
  cd build

  export PATH=$PWD/bin:$PATH
  export CXXFLAGS+=" -fno-delete-null-pointer-checks"

  qmake-qt5 WEBENGINE_CONFIG+=use_proprietary_codecs ../${_namefqn}
  make
  export PATH=$SAVEPATH
  unset SAVEPATH
  make INSTALL_ROOT=$PKG install

  find $PKG/$QT5DIR/lib/pkgconfig -name "*.pc" -exec perl -pi -e "s, -L$PWD/?\S+,,g" {} \;

  find $PKG/$QT5DIR/ -name qt_lib_bootstrap_private.pri \
     -exec sed -i -e "s:$PWD/qtbase:/$QT5DIR/lib/:g" {} \;

  find $PKG/$QT5DIR/ -name \*.prl \
     -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \;
}
devel() {
  cd $PKG
  bsdtar -cf \
     $PKGMK_PACKAGE_DIR/$name.devel${PKGMK_BUILDVER}any.${PKGMK_PACKAGE_EXT} \
     usr/include \
     usr/lib/pkgconfig \
     usr/mkspecs
  rm -r usr/{include,mkspecs,lib/pkgconfig}
}
