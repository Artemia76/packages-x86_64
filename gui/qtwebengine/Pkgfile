description="Provides support for web applications using the Chromium browser project"
url="http://qt-project.org/"

packager="tnut <tnut@nutyx.org>"
contributors="Pierre B, Rems"

makedepends=(gzip qtbase qtwebchannel qtlocation xorg-libxcomposite
             xorg-libxrandr pciutils libvpx libevent snappy nss
             protobuf libxslt ffmpeg git gperf icu zlib libwebp
             xorg-libxscrnsaver alsa-lib pulseaudio)

name=qtwebengine
version=5.15.2

_name="${name}-everywhere-src"

source=(http://www.linuxfromscratch.org/patches/blfs/svn/qtwebengine-everywhere-src-$version-ICU68-1.patch
        https://download.qt.io/official_releases/qt/${version:0:4}/$version/submodules/${_name}-${version}.tar.xz)

prepare() {
  cd ${_name}-$version

  find -type f -name "*.pr[io]" |
  xargs sed -i -e 's|INCLUDEPATH += |&$$QTWEBENGINE_ROOT/include |'
 
  patch -Np1 -i ../qtwebengine-everywhere-src-5.15.2-ICU68-1.patch 

  sed -e '/link_pulseaudio/s/false/true/' \
    -i src/3rdparty/chromium/media/media_options.gni

  sed -i 's/NINJAJOBS/NINJA_JOBS/' src/core/gn_run.pro

  # Disable jumbo build https://bugreports.qt.io/browse/QTBUG-88657
  sed -i 's|use_jumbo_build=true|use_jumbo_build=false|' -i src/buildtools/config/common.pri

  cd ..
}
build() {
  mkdir build
  cd build 

  qmake ../${_name}-$version -- -system-ffmpeg -webengine-icu

  make
  make INSTALL_ROOT=$PKG install

# Obsolets libs
rm $PKG/usr/lib/libQt5WebEngine.la
rm $PKG/usr/lib/libQt5WebEngineCore.la
rm $PKG/usr/lib/libQt5WebEngineWidgets.la

# Drop QMAKE_PRL_BUILD_DIR because reference the build dir
find $PKG/usr/lib -type f -name '*.prl' \
    -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \;
}
